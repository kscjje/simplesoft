<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
		xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
		layout:decorate="~{layouts/mypage_layout}">
		<main class="content-wrapper" layout:fragment="content" style="padding: 10px;">
			<style>
				.content-container {
					max-width: 600px;
					min-height: 53vh;
					margin: 0 auto;
				}
				.content-container-hedaer {
					max-width: 1200px;
					margin: 0 auto;
				}
			</style>
			<script src="/js/common/naveridlogin_js_sdk_2.0.2.js"></script>
			<script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
			<div class="content-container-hedaer justify-content-center text-center">
				<th:block th:replace="fragments/mypageTabs :: mypageTabs(${activeMenu})"></th:block>
			</div>
			<div class="content-container justify-content-center text-center">
				
				<th:block th:if="${session.memberInfo == null}">
					<div class="rounded-lg p-4 h-90 overflow-y-auto text-sm text-gray-700 leading-relaxed mb-5">
						<div class="gap-3 bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
							<p class="text-lg font-bold mb-2">비밀번호 확인</p>
							<p class="text-sm leading-relaxed">
								<strong class="text-gray-500">회원정보 보호를 위해 고객님의 본인 확인 절차가 필요하며,<br>비밀번호 입력을 부탁드립니다.</strong>
							</p>
						</div>
						<!-- 비밀번호 -->
						<div class="mb-4">
							<label for="pwd" class="block mb-2 text-sm font-bold text-gray-700 text-start">비밀번호 확인<font color="red"> *</font></label>
							<input type="password" name="pwd" id="pwd" autofocus placeholder="비밀번호를 입력해 주세요." maxlength="20" onkeypress="enterKey()"
								class="w-full px-4 py-3 border border-gray-300 text-lg rounded focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-transparent">
						</div>
						<!-- 로그인 버튼 -->
						<button type="button" class="w-full py-3 font-bold text-white bg-black rounded hover:bg-gray-800 transition-colors" onclick="fnLogin()">
							확인
						</button>
					</div>
				</th:block>
				<th:block th:if="${session.memberInfo != null}">
					<div class="bg-white rounded-2xl card-shadow p-10">
						<!-- 프로필 아이콘 -->
						<div class="flex justify-center mb-6">
							<div class="w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center">
								<i class="fas fa-user text-2xl text-gray-400"></i>
							</div>
						</div>
					
						<h3 class="text-lg font-semibold text-gray-700 text-center mb-8">
							내 정보 관리
						</h3>
						<!-- 정보 영역 -->
						<div class="space-y-4 text-sm">
							<div class="flex justify-between border-b pb-3">
								<span class="text-gray-500">고객명</span>
								<span class="text-gray-800 font-medium" th:text="${getMember.userNm}"></span>
							</div>
							<div class="flex justify-between border-b pb-3">
								<span class="text-gray-500">이메일</span>
								<span class="text-gray-800 font-medium" th:text="${getMember.userEmail}"></span>
							</div>
							<div class="flex justify-between border-b pb-3">
								<span class="text-gray-500">연락처</span>
								<span class="text-gray-800 font-medium" th:text="${getMember.userMobile}"></span>
							</div>
						</div>
						<!-- 액션 영역 -->
						<div class="mt-10 space-y-4 sm:space-y-0 sm:flex sm:gap-4">
							<!-- 비밀번호 변경 -->
							<button type="button" onclick="openPasswordModal()" class="w-full sm:flex-1 flex items-center justify-center gap-2 px-6 py-3 text-sm font-semibold rounded-xl border border-gray-300 text-gray-700 hover:border-green-600 hover:text-green-600 transition">
								<i class="fas fa-lock text-sm"></i>
								비밀번호 변경
							</button>
					
							<!-- 간편 로그인 -->
							<button type="button" onclick="openSnsLoginModal()" class="w-full sm:flex-1 flex items-center justify-center gap-2 px-6 py-3 text-sm font-semibold rounded-xl border border-gray-300 text-gray-700 hover:border-blue-500 hover:text-blue-500 transition">
								<i class="fas fa-sign-in-alt text-sm"></i>
								간편 로그인
							</button>
						</div>
					
						<!-- 회원탈퇴 -->
						<div class="mt-4">
							<button type="button" onclick="deleteMember()" class="w-full flex items-center justify-center gap-2 px-6 py-3 text-sm font-semibold rounded-xl text-white bg-red-600 hover:bg-red-700 transition">
								<i class="fas fa-user-slash text-sm"></i>
								회원탈퇴
							</button>
						</div>
					
					</div>

				</th:block>
			</div>
			
			<!-- 비밀번호 변경 모달 -->
			<div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
				<div class="bg-white rounded-2xl p-8 w-11/12 max-w-md shadow-lg relative">
			
					<!-- 모달 헤더 -->
					<h3 class="text-lg font-semibold text-gray-700 text-center mb-6">비밀번호 변경</h3>
			
					<!-- 닫기 버튼 -->
					<button type="button" onclick="closePasswordModal()"
							class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
						<i class="fas fa-times"></i>
					</button>
			
					<form id="changePasswordForm" class="space-y-4">
						<div>
							<label class="block text-gray-500 text-sm mb-1">현재 비밀번호</label>
							<input type="password" name="currentPassword" id="currentPassword" required placeholder="현재 비밀번호를 입력해 주세요."
								   class="w-full px-4 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
						</div>
						<div>
							<label class="block text-gray-500 text-sm mb-1">새 비밀번호</label>
							<input type="password" name="newPassword" id="newPassword" required placeholder="영문, 숫자, 특수문자 조합 8-20자"
								   class="w-full px-4 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
						</div>
						<div>
							<label class="block text-gray-500 text-sm mb-1">새 비밀번호 확인</label>
							<input type="password" name="confirmPassword" id="confirmPassword" required placeholder="비밀번호를 다시 입력해 주세요."
								   class="w-full px-4 py-2 border rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-green-500">
						</div>
			
						<!-- 버튼 그룹 -->
						<div class="flex gap-4 mt-4">
							<button type="button" onclick="closePasswordModal()"
									class="flex-1 px-4 py-2 border rounded-xl text-gray-600 hover:bg-gray-100 transition">
								취소
							</button>
							<button type="submit"
									class="flex-1 px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
								변경
							</button>
						</div>
					</form>
				</div>
			</div>
			
			<!-- 간편로그인 연동 모달 -->
			<div id="snsLoginModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
				<div class="bg-white rounded-lg p-6 relative w-11/12 max-w-xl">
			        <!-- 모달 헤더 -->
			        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">간편로그인 수정</h3>
			
			        <!-- 안내 문구 -->
			        <p class="text-sm text-gray-500 text-center mb-6">
			            회원님의 SNS 계정을 연동하여 간편하게 로그인 하실 수 있도록 지원합니다.<br>
			            기존에 연동되어 있는 SNS는 해제할 수 있고, 미연동된 SNS는 추가 연동이 가능합니다.
			        </p>
			
			        <!-- SNS 버튼 -->
			        <div class="space-y-3">
			            <!-- 네이버 -->
			            <div class="flex items-center justify-between border rounded-md p-3 hover:bg-gray-50 transition cursor-pointer">
			                <div class="flex items-center gap-3">
			                    <img src="/image/ico_sns_naver.svg" alt="네이버">
			                    <span class="text-gray-700 font-medium">네이버 로그인</span>
			                </div>
			                <button type="button" id="naverIdLogin_loginButton" class="px-3 py-3 border border-gray-300 rounded-md text-sm hover:bg-gray-100 transition">
			                    연동하기
			                </button>
			            </div>
			
			            <!-- 카카오 -->
			            <div class="flex items-center justify-between border rounded-md p-3 hover:bg-gray-50 transition cursor-pointer">
			                <div class="flex items-center gap-3">
			                    <img src="/image/ico_sns_kakao.svg" alt="카카오">
			                    <span class="text-gray-700 font-medium">카카오 로그인</span>
			                </div>
			                <button type="button" id="kakaoIdLogin_loginButton" onclick="fn_kakao_join()" class="px-3 py-3 border border-gray-300 rounded-md text-sm hover:bg-gray-100 transition">
			                    연동하기
			                </button>
			            </div>
			        </div>
			
			        <!-- 닫기 버튼 -->
			        <button onclick="closeSnsLoginModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
			            &times;
			        </button>
			        
			        <div class="flex gap-4 mt-4">
						<button type="button" onclick="closeSnsLoginModal()"
								class="flex-1 px-4 py-2 border rounded-xl text-gray-600 hover:bg-gray-100 transition">
							닫기
						</button>
					</div>
			    </div>
			</div>


			<script th:inline="javascript">
				fnLogin = function(){
					let pwd = $('#pwd').val();
					
					if(pwd == ""){
						alert("비밀번호를 입력해 주세요.")
						$('#pwd').focus();
						return;
					}
					let loginInfo = {
						userPw : pwd
					}
					$.ajax({
						url : "/rest/member/memberInfoAjax",
						type : "POST",
						dataType : "json",
						data : loginInfo,
						success : function(data) {
							if(data.data.RESULT == "SUCCESS"){
								location.reload();
							} else if(data.data.RESULT == "NONE"){
								location.reload();
							} else {
								alert("비밀번호가 정확하지 않습니다.");
								$('#userPw').val("");
							}
						}, error : function(request, status, error) {
							alert("에러코드: " + request.status + "\n메시지: " + request.responseText);
						}
					});
				}
				enterKey = function(type){
					if (window.event.keyCode == 13) {
						fnLogin();
					}
				}
				
				deleteMember = function (addressSeq){
					if (!confirm("정말 탈퇴하시겠습니까?")) {
						return;
					}
					$.ajax({
						url : "/rest/member/delete",
						type : "POST",
						dataType : "json",
						success : function(data) {
							location.href="/main"
						}, error : function(request, status, error) {
							alert("에러코드: " + request.status + "\n메시지: " + request.responseText);
						}
					});
				}
				
				openPasswordModal = function() {
					const modal = document.getElementById('passwordModal');
					modal.classList.remove('hidden');
					modal.classList.add('flex');
					
					$("#newPassword").val('');
					$("#currentPassword").val('');
					$("#confirmPassword").val('');
				}
				
				closePasswordModal = function() {
					const modal = document.getElementById('passwordModal');
					modal.classList.add('hidden');
					modal.classList.remove('flex');
				}
				
				document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
					e.preventDefault();
					const form = e.target;
					const current = form.currentPassword.value;
					const newPwd = form.newPassword.value;
					const confirm = form.confirmPassword.value;
				
					const validation = validatePassword(newPwd);
					
					if(current === newPwd){
						alert("동일한 비밀번호로는 변경이 불가능 합니다.");
						return;
					} else if (newPwd !== confirm) {
						alert("새 비밀번호와 확인이 일치하지 않습니다.");
						return;
					} else if (!validation.isValid) {	// ✅ 비밀번호 유효성 검증 추가
						alert(validation.messages.join(' '));
						$("#userPw").focus();
						return;
					}
					const memberVO = {
						current : current,
						newPwd : newPwd
					}
					// AJAX로 서버에 전송
					$.ajax({
						url: "/rest/member/passwordUpdate", // 실제 API 엔드포인트로 수정
						type: "POST",
						data: memberVO,
						dataType: "json",
						success: function(result) {
							if (result.responseCode === "SUCCESS") {
								if(result.data.RESULT === "NONE"){
									location.reload();
								} else if (result.data.RESULT === "SUCCESS"){
									alert("비밀번호가 변경되었습니다!\n변경된 비밀번호로 다시 로그인해 주세요.");	
									location.href="/logout";
								} else if(result.data.RESULT === "FAIL"){
									alert(result.data.PARAM_MESSAGE);
									return;
								}
							} else {
								alert('비밀번호 변경에 실패했습니다.');
								return;
							}
							closePasswordModal();
						},
						error: function(xhr, status, error) {
							alert('비밀번호 변경 처리 중 오류가 발생했습니다. \n고객센터에 문의해 주세요.');
						},
					});
					
					// TODO: AJAX 서버 요청
					
					
				});
				
				// 비밀번호 유효성 검사 함수
				function validatePassword(password) {
					const result = {
						isValid: true,
						messages: []
					};
					
					// 길이 체크
					if (password.length < 8 || password.length > 20) {
						result.isValid = false;
						result.messages.push('8-20자로 입력해주세요.');
					}
					
					// 영문 포함 체크
					if (!/[a-zA-Z]/.test(password)) {
						result.isValid = false;
						result.messages.push('영문자를 포함해야 합니다.');
					}
					
					// 허용되지 않는 문자 체크
					if (/[^a-zA-Z0-9!@#$%^&*()_+]/.test(password)) {
						result.isValid = false;
						result.messages.push('허용되지 않는 문자가 포함되어 있습니다.');
					}
					
					return result;
				}
				
				openSnsLoginModal = function() {
					const modal = document.getElementById('snsLoginModal');
					modal.classList.remove('hidden');
					modal.classList.add('flex');
					fn_sns_list();
				}
				
				closeSnsLoginModal = function() {
					const modal = document.getElementById('snsLoginModal');
					modal.classList.add('hidden');
					modal.classList.remove('flex');
				}
				
				Kakao.init(/*[[${kakaoKey}]]*/ "");
				function fn_kakao_join() {
					Kakao.Auth.login({
						success: function () {
							Kakao.API.request({
								url: '/v2/user/me',
								success: function (res) {
									const memberId = res.id;
									if (memberId === undefined || memberId == null) {
										alert("카카오 연결이 실패하였습니다");
										return;
									} else {
										fn_sns_join(memberId, '', '2001');
									}
								},
								fail: function (error) {
									alert("카카오 연결이 실패하였습니다. - " + JSON.stringify(error));
								}
							});
						},
						fail: function (err) {
							//console.log(JSON.stringify(err.error))
						}
					});
				}
				/*<![CDATA[*/
			    // 네이버 로그인 객체 생성
				const naverLogin = new naver.LoginWithNaverId({
				    clientId: /*[[${naverKey}]]*/ "",
		            callbackUrl: /*[[${currentDomain}]]*/ "",
		            isPopup: true // 팝업용
				});
				
				naverLogin.init();
				/*]]>*/
				
				function fn_sns_join_with_naver(snsId, snsEmail, snsKind, popupWindow) {
					//네이버 간편로그인으로 접근했을때
					popupWindow.close();
					fn_sns_join(snsId, snsEmail, snsKind);
				}
				function fn_sns_join(snsId, snsEmail, snsKind) {
					var snsNm = '';
					if (snsKind == '1001') {
						snsNm = '네이버';
					} else if (snsKind == '2001') {
						snsNm = '카카오';
					}
					$.ajax({
						url: "/rest/member/insertSimpleLoginId",
						type: "POST",
						data: {
							snsId: snsId,
							snsKind: snsKind,
							snsEmail:snsEmail
					    },
						dataType: "json",
						success: function(result) {
							if(result.data.RESULT ==="NONE"){
								location.reload();
								return;
							} else {
								alert("등록 되었습니다.");
								if (snsKind == '1001') {
									var parent = $('#naverIdLogin_loginButton').parent();
									$('#naverIdLogin_loginButton').remove();
									parent.append('<button id="naverIdLogin_loginButton" class="px-3 py-3 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition">연동해제</button>');
									$('#naverIdLogin_loginButton').attr('onclick', 'fn_sns_cancel("1001")');
								} else if (snsKind == '2001') {
									$('#kakaoIdLogin_loginButton').text('연동해제');
									$('#kakaoIdLogin_loginButton').attr('class', 'px-3 py-3 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition');
									$('#kakaoIdLogin_loginButton').attr('onclick', 'fn_sns_cancel("2001")');
								}
							}
						},
						error: function(xhr, status, error) {
							alert('간편로그인 등록 중 오류가 발생했습니다. \n고객센터에 문의해 주세요.');
						},
					});
				}
				
				function fn_sns_list() {
					$.ajax({
						url: "/rest/member/simpleLoginList",
						type: "GET",
						dataType: "json",
						success: function(result) {
							if(result.data.RESULT ==="NONE"){
								location.reload();
								return;
							} else {
								$.each(result.data.list, function (index, item) {
									if (item.snsKind == '1001' && item.snsState == '1') {
										var parent = $('#naverIdLogin_loginButton').parent();
										$('#naverIdLogin_loginButton').remove();
										parent.append('<button id="naverIdLogin_loginButton" class="px-3 py-3 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition">연동해제</button>');
										$('#naverIdLogin_loginButton').attr('onclick', 'fn_sns_cancel("1001")');
									} else if (item.snsKind == '2001' && item.snsState == '1') {
										$('#kakaoIdLogin_loginButton').text('연동해제');
										$('#kakaoIdLogin_loginButton').attr('class', 'px-3 py-3 rounded-md text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 transition');
										$('#kakaoIdLogin_loginButton').attr('onclick', 'fn_sns_cancel("2001")');
									}
								});
							}
						},
						error: function(xhr, status, error) {
							alert('간편로그인 정보를 불러오는 중 오류가 발생했습니다. \n고객센터에 문의해 주세요.');
						},
					});
				}
				
				function fn_sns_cancel(snsKind) {
					$.ajax({
						url: "/rest/member/deleteSimpleLoginId",
						data: {snsKind: snsKind},
						type: "POST",
						dataType: "json",
						success: function(result) {
							if(result.data.RESULT ==="NONE"){
								location.reload();
								return;
							} else {
								alert("해제 되었습니다.")
								if (snsKind == '1001') {
									var parent = $('#naverIdLogin_loginButton').parent();
									$('#naverIdLogin_loginButton').remove();
									parent.append('<button id="naverIdLogin_loginButton" class="px-3 py-3 border border-gray-300 rounded-md text-sm hover:bg-gray-100 transition">연동하기</button>');
									naverLogin.init();
								} else if (snsKind == '2001') {
									$('#kakaoIdLogin_loginButton').text('연동하기');
									$('#kakaoIdLogin_loginButton').attr('class', 'px-3 py-3 border border-gray-300 rounded-md text-sm hover:bg-gray-100 transition');
									$('#kakaoIdLogin_loginButton').attr('onclick', 'fn_kakao_join()');
								}
							}
						},
						error: function(xhr, status, error) {
							alert('간편로그인 정보를 불러오는 중 오류가 발생했습니다. \n고객센터에 문의해 주세요.');
						},
					});
				}
			</script>

		</main>
</html>