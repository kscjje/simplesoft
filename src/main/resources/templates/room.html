<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8" />
	<title>ì´ê¹€ì²­ë…„ë¶€ ë°©íƒˆì¶œ</title>
	<link rel="stylesheet" href="/css/tailwind.min.css">
	<link rel="stylesheet" href="/css/all.min.css">
	<link rel="stylesheet" href="/css/room.css">
	<script src="/js/common/jquery-3.6.0.min.js"></script>
</head>
<body>
	<h1>ğŸ” Escape Room Timer</h1>

	<div class="timer" id="timer">20:00</div>
	
	<!-- íŒíŠ¸ ì½”ë“œ ì…ë ¥ -->
	<div class="hint-inputs" aria-label="íŒíŠ¸ ì½”ë“œ ì…ë ¥">
		<input type="text" maxlength="1" class="hint-input" id="code1" autocomplete="off" />
		<input type="text" maxlength="1" class="hint-input" id="code2" autocomplete="off" />
		<input type="text" maxlength="1" class="hint-input" id="code3" autocomplete="off" />
		<input type="text" maxlength="1" class="hint-input" id="code4" autocomplete="off" />
	</div>
	
	<div class="mt-5">íŒíŠ¸ ì‚¬ìš© : <span id="hindCnt">0</span> / 4</div>
	<div class="flex items-center space-x-2 mt-5">
		<button type="button" class="btn" id="check-hint-btn">íŒíŠ¸ í™•ì¸</button>
		<button type="button" id="clear-inputs-btn" style="width:3.5rem;height: 3.3rem" class="btn flex items-center justify-center text-gray-600 hover:text-red-500">
			<i class="fas fa-eraser"></i>
		</button>
	</div>
	<div class="hint-box" id="hint-box">íŒíŠ¸ë¥¼ ì…ë ¥í•˜ê³  'íŒíŠ¸ í™•ì¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>

	<!-- ì‹œì‘ ëª¨ë‹¬ -->
	<div id="start-modal">
		<div class="modal-content">
			<h2>ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
			<button id="start-yes">ë„¤, ì‹œì‘í•©ë‹ˆë‹¤</button>
		</div>
	</div>
	
	<script>
		const TIMER_DURATION = 1200; // 20ë¶„
		let seconds = TIMER_DURATION;
		let interval;

		// íŒíŠ¸ ì½”ë“œ ì‚¬ì „
		const HINT_CODES = {
			'1234': 'ì²« ë²ˆì§¸ í¼ì¦ì˜ ë‹µì€ ì‹œê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”.',
			'5678': 'ë‘ ë²ˆì§¸ íŒíŠ¸: ì±…ì¥ì˜ ë¹¨ê°„ ì±…ì„ ì°¾ì•„ë³´ì„¸ìš”.',
			'9012': 'ì„¸ ë²ˆì§¸ íŒíŠ¸: ê¸ˆê³  ë²ˆí˜¸ëŠ” ìƒì¼ê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤.',
			'3456': 'ë„¤ ë²ˆì§¸ íŒíŠ¸: ê±°ìš¸ ë’¤í¸ì„ í™•ì¸í•´ë³´ì„¸ìš”.'
		};

		// íƒ€ì´ë¨¸ í‘œì‹œ
		function startTimer() {
			if (interval) return;

			interval = setInterval(() => {
				if (seconds <= 0) {
					clearInterval(interval);
					document.getElementById('timer').innerText = '00:00';
					return;
				}
				const min = String(Math.floor(seconds / 60)).padStart(2, '0');
				const sec = String(seconds % 60).padStart(2, '0');
				document.getElementById('timer').innerText = `${min}:${sec}`;
				seconds--;
			}, 1000);
		}

		const modal = document.getElementById('start-modal');
		const btnYes = document.getElementById('start-yes');
		
		btnYes.addEventListener('click', () => {
			saveStartTimeToServer();
		});
			
		// ì‹œì‘ ì‹œê°„ ì„œë²„ ì €ì¥ (POST)
		function saveStartTimeToServer() {
			$.ajax({
				url: '/start',
				type: 'POST',
				dataType: 'json',
				success: function (res) {
					if(res.data.RET_CODE == "FAIL"){
						alert("ì‚¬ìš©ìë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.");
						return;
					}
					startTimer();
					modal.style.display = 'none';
				},
				error: function () {
					console.error('ì‹œì‘ ì‹œê°„ ì €ì¥ ì‹¤íŒ¨');
				}
			});
		}

		// ì‹œì‘ ì‹œê°„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (GET)
		function loadStartTimeFromServer(callback) {
			$.ajax({
				url: '/load',
				type: 'GET',
				dataType: 'json',
				success: function (res) {
					if (res && res.data) {
						callback(res.data);
					} else {
						callback(null);
					}
				},
				error: function () {
					callback(null);
				}
			});
		}

		// íŒíŠ¸ ì‚¬ìš©
		function useHint(index) {
			$.ajax({
				url: '/useHint',
				type: 'GET',
				dataType: 'json',
				data : {
					index : index
				},
				success: function (res) {
					let data = res.data;
					let hintCount = 0;
					let hint1 = data.hint1 == "Y" ? 1 : 0;
					let hint2 = data.hint2 == "Y" ? 1 : 0;
					let hint3 = data.hint3 == "Y" ? 1 : 0;
					let hint4 = data.hint4 == "Y" ? 1 : 0;
					let hint5 = data.hint5 == "Y" ? 1 : 0;
					hintCount = hint1 + hint2 + hint3 + hint4 + hint5;
					const hindCnt = document.getElementById('hindCnt'); 
					hindCnt.textContent = hintCount
				},
				error: function () {
				}
			});
		}
		// ì…ë ¥ì°½ ìë™ í¬ì»¤ì‹± ë° ìœ íš¨ì„±
		const hintInputs = [
			document.getElementById('code1'),
			document.getElementById('code2'),
			document.getElementById('code3'),
			document.getElementById('code4')
		];

		function clearInputs() {
			hintInputs.forEach(input => input.value = '');
			hintInputs[0].focus();
		}

		document.getElementById('clear-inputs-btn').addEventListener('click', () => {
			$(".hint-input").val("");
		});
		document.getElementById('check-hint-btn').addEventListener('click', () => {
			const code = hintInputs.map(i => i.value.trim()).join('');
			const hintBox = document.getElementById('hint-box');
			const hindCnt = document.getElementById('hindCnt');

			if (code.length !== 4) {
				hintBox.textContent = '4ìë¦¬ íŒíŠ¸ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
				hintBox.style.color = '#ff00ff';
				return;
			}

			if (HINT_CODES[code]) {
				hintBox.textContent = HINT_CODES[code];
				hintBox.style.color = '#00ffff';
				clearInputs();
				
				const keys = Object.keys(HINT_CODES); // ['1234', '5678', '9012', '3456']
				const index = keys.indexOf(code);     // codeê°€ '5678'ì´ë©´ indexëŠ” 1
				useHint(index);
			} else {
				hintBox.textContent = 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒíŠ¸ ì½”ë“œì…ë‹ˆë‹¤.';
				hintBox.style.color = '#ff0044';
			}
		});

		hintInputs.forEach((input, idx) => {
			input.addEventListener('input', e => {
				e.target.value = e.target.value.toUpperCase().slice(0, 1);
				if (e.target.value && idx < hintInputs.length - 1) {
					hintInputs[idx + 1].focus();
				}
			});
			input.addEventListener('keydown', e => {
				if (e.key === 'Backspace' && !e.target.value && idx > 0) {
					hintInputs[idx - 1].focus();
				}
			});
		});

		// í˜ì´ì§€ ë¡œë“œì‹œ ì„œë²„ì—ì„œ ì‹œì‘ì‹œê°„ ë¶ˆëŸ¬ì™€ì„œ íƒ€ì´ë¨¸ ê³„ì‚°
		window.addEventListener('DOMContentLoaded', () => {
			loadStartTimeFromServer(function (data) {
				if (data.regDt) {
					modal.style.display = 'none';
					const now = new Date();
					const start = new Date(data.regDt);
					const elapsed = Math.floor((now - start) / 1000);
					seconds = Math.max(TIMER_DURATION - elapsed, 0);
					
					let hintCount = 0;
					let hint1 = data.hint1 == "Y" ? 1 : 0;
					let hint2 = data.hint2 == "Y" ? 1 : 0;
					let hint3 = data.hint3 == "Y" ? 1 : 0;
					let hint4 = data.hint4 == "Y" ? 1 : 0;
					let hint5 = data.hint5 == "Y" ? 1 : 0;
					hintCount = hint1 + hint2 + hint3 + hint4 + hint5;
					const hindCnt = document.getElementById('hindCnt'); 
					hindCnt.textContent = hintCount
					startTimer();
				}
			});
		});
	</script>
</body>
</html>
