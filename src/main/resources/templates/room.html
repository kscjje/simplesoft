<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8" />
	<title>이김청년부 방탈출</title>
	<link rel="stylesheet" href="/css/tailwind.min.css">
	<link rel="stylesheet" href="/css/all.min.css">
	<link rel="stylesheet" href="/css/room.css">
	<script src="/js/common/jquery-3.6.0.min.js"></script>
</head>
<body>
	<h1>🔐 Escape Room Timer</h1>

	<div class="timer" id="timer">20:00</div>
	
	<!-- 힌트 코드 입력 -->
	<div class="hint-inputs" aria-label="힌트 코드 입력">
		<input type="text" maxlength="1" class="hint-input" id="code1" autocomplete="off" onkeydown="enterKey()"/>
		<input type="text" maxlength="1" class="hint-input" id="code2" autocomplete="off" onkeydown="enterKey()"/>
		<input type="text" maxlength="1" class="hint-input" id="code3" autocomplete="off" onkeydown="enterKey()"/>
		<input type="text" maxlength="1" class="hint-input" id="code4" autocomplete="off" onkeydown="enterKey()"/>
	</div>
	
	<div class="mt-5">힌트 사용 : <span id="hindCnt">0</span> / 4</div>
	<div class="flex items-center space-x-2 mt-5">
		<button type="button" class="btn" id="check-hint-btn">힌트 확인</button>
		<button type="button" id="clear-inputs-btn" style="width:3.5rem;height: 3.3rem" class="btn flex items-center justify-center text-gray-600 hover:text-red-500">
			<i class="fas fa-eraser"></i>
		</button>
	</div>
	<div class="hint-box" id="hint-box">힌트코드를 입력하고 '힌트 확인' 버튼을 눌러주세요.</div>

	<!-- 시작 모달 -->
	<div id="start-modal">
		<div class="modal-content">
			<h2>게임을 시작하시겠습니까?</h2>
			<button type="button" id="start-yes">네, 시작합니다</button>
		</div>
	</div>
	
	<!-- 힌트 모달 -->
	<div id="hint1-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="식단표" class="mb-5">
			<button type="button" id="hint1-yes">확인</button>
		</div>
	</div>
	
	<div id="hint2-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="식단표" class="mb-5">
			<button type="button" id="hint2-yes">확인</button>
		</div>
	</div>
	
	<div id="hint3-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="식단표" class="mb-5">
			<button type="button" id="hint3-yes">확인</button>
		</div>
	</div>
	
	<div id="hint4-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="식단표" class="mb-5">
			<button type="button" id="hint4-yes">확인</button>
		</div>
	</div>
	
	<script>
		const TIMER_DURATION = 1200; // 20분
		let seconds = TIMER_DURATION;
		let interval;

		// 힌트 코드 사전
		const HINT_CODES = {
			'1234': `첫 번째 퍼즐의 답은 시계를 확인하세요. <br><button class="btn btn-hint mt-2" onclick="$('#hint1-modal').show();">정답 확인</button>`,
			'5678': `두 번째 힌트: 책장의 빨간 책을 찾아보세요. <br><button class="btn btn-hint mt-2" onclick="$('#hint2-modal').show();">정답 확인</button>`,
			'9012': `세 번째 힌트: 금고 번호는 생일과 관련이 있습니다. <br><button class="btn btn-hint mt-2" onclick="$('#hint3-modal').show();">정답 확인</button>`,
			'3456': `네 번째 힌트: 거울 뒤편을 확인해보세요. <br><button class="btn btn-hint mt-2" onclick="$('#hint4-modal').show();">정답 확인</button>`,
		};

		// 타이머 표시
		function startTimer() {
			if (interval) return;

			interval = setInterval(() => {
				if (seconds <= 0) {
					clearInterval(interval);
					document.getElementById('timer').innerText = '00:00';
					return;
				}
				const min = String(Math.floor(seconds / 60)).padStart(2, '0');
				const sec = String(seconds % 60).padStart(2, '0');
				document.getElementById('timer').innerText = `${min}:${sec}`;
				seconds--;
			}, 1000);
		}

		const modal = document.getElementById('start-modal');
		const btnYes = document.getElementById('start-yes');
		
		const hint1Modal = document.getElementById('hint1-modal');
		const hint2Modal = document.getElementById('hint2-modal');
		const hint3Modal = document.getElementById('hint3-modal');
		const hint4Modal = document.getElementById('hint4-modal');
		
		btnYes.addEventListener('click', () => {
			saveStartTimeToServer();
		});
		hint1Modal.addEventListener('click', () => {
			$('#hint1-modal').hide();
		});
		hint2Modal.addEventListener('click', () => {
			$('#hint2-modal').hide();
		});
		hint3Modal.addEventListener('click', () => {
			$('#hint3-modal').hide();
		});
		hint4Modal.addEventListener('click', () => {
			$('#hint4-modal').hide();
		});
			
		// 시작 시간 서버 저장 (POST)
		function saveStartTimeToServer() {
			$.ajax({
				url: '/start',
				type: 'POST',
				dataType: 'json',
				success: function (res) {
					if(res.data.RET_CODE == "FAIL"){
						alert("사용자를 등록해 주세요.");
						return;
					}
					startTimer();
					modal.style.display = 'none';
				},
				error: function () {
					console.error('시작 시간 저장 실패');
				}
			});
		}

		// 시작 시간 서버에서 불러오기 (GET)
		function loadStartTimeFromServer(callback) {
			$.ajax({
				url: '/load',
				type: 'GET',
				dataType: 'json',
				success: function (res) {
					if (res && res.data) {
						callback(res.data);
					} else {
						callback(null);
					}
				},
				error: function () {
					callback(null);
				}
			});
		}

		// 힌트 사용
		function useHint(index) {
			$.ajax({
				url: '/useHint',
				type: 'GET',
				dataType: 'json',
				data : {
					index : index
				},
				success: function (res) {
					let data = res.data;
					let hintCount = 0;
					let hint1 = data.hint1 == "Y" ? 1 : 0;
					let hint2 = data.hint2 == "Y" ? 1 : 0;
					let hint3 = data.hint3 == "Y" ? 1 : 0;
					let hint4 = data.hint4 == "Y" ? 1 : 0;
					let hint5 = data.hint5 == "Y" ? 1 : 0;
					hintCount = hint1 + hint2 + hint3 + hint4 + hint5;
					const hindCnt = document.getElementById('hindCnt'); 
					hindCnt.textContent = hintCount
				},
				error: function () {
				}
			});
		}
		// 입력창 자동 포커싱 및 유효성
		const hintInputs = [
			document.getElementById('code1'),
			document.getElementById('code2'),
			document.getElementById('code3'),
			document.getElementById('code4')
		];

		function clearInputs() {
			hintInputs.forEach(input => input.value = '');
			hintInputs[0].focus();
		}

		document.getElementById('clear-inputs-btn').addEventListener('click', () => {
			$(".hint-input").val("");
		});
		document.getElementById('check-hint-btn').addEventListener('click', () => {
			const code = hintInputs.map(i => i.value.trim()).join('');
			const hintBox = document.getElementById('hint-box');
			const hindCnt = document.getElementById('hindCnt');

			if (code.length !== 4) {
				hintBox.textContent = '4자리 힌트 코드를 모두 입력해주세요.';
				hintBox.style.color = '#ff00ff';
				return;
			}

			if (HINT_CODES[code]) {
				const keys = Object.keys(HINT_CODES); // ['1234', '5678', '9012', '3456']
				const index = keys.indexOf(code);     // code가 '5678'이면 index는 1
				
				const timerText = document.getElementById('timer').innerText;
				const [min, sec] = timerText.split(':').map(Number);
				const totalSeconds = min * 60 + sec;
				const timeLimit = [19,6,7,8];
				
				if (totalSeconds >= timeLimit[index]*60) { // 15분 이상
					hintBox.textContent = `이 힌트는 ${timeLimit[index]}분 이하일 때만 사용할 수 있습니다.`;
					hintBox.style.color = '#ff0044';
					clearInputs();
					return; // 함수 탈출하여 더 이상 진행 안 함
				}
				
				hintBox.innerHTML = HINT_CODES[code];
				hintBox.style.color = '#00ffff';
				clearInputs();
				
				
				useHint(index);
			} else {
				hintBox.textContent = '올바르지 않은 힌트 코드입니다.';
				hintBox.style.color = '#ff0044';
			}
		});

		hintInputs.forEach((input, idx) => {
			input.addEventListener('input', e => {
				e.target.value = e.target.value.toUpperCase().slice(0, 1);
				if (e.target.value && idx < hintInputs.length - 1) {
					hintInputs[idx + 1].focus();
				}
			});
			input.addEventListener('keydown', e => {
				if (e.key === 'Backspace' && !e.target.value && idx > 0) {
					hintInputs[idx - 1].focus();
				}
			});
		});

		// 페이지 로드시 서버에서 시작시간 불러와서 타이머 계산
		window.addEventListener('DOMContentLoaded', () => {
			loadStartTimeFromServer(function (data) {
				if (data.regDt) {
					modal.style.display = 'none';
					const now = new Date();
					const start = new Date(data.regDt);
					const elapsed = Math.floor((now - start) / 1000);
					seconds = Math.max(TIMER_DURATION - elapsed, 0);
					
					let hintCount = 0;
					let hint1 = data.hint1 == "Y" ? 1 : 0;
					let hint2 = data.hint2 == "Y" ? 1 : 0;
					let hint3 = data.hint3 == "Y" ? 1 : 0;
					let hint4 = data.hint4 == "Y" ? 1 : 0;
					let hint5 = data.hint5 == "Y" ? 1 : 0;
					hintCount = hint1 + hint2 + hint3 + hint4 + hint5;
					const hindCnt = document.getElementById('hindCnt'); 
					hindCnt.textContent = hintCount
					startTimer();
				}
			});
		});
		enterKey = function(type){
			if (window.event.keyCode == 13) {
				$('#check-hint-btn').trigger("click");
			}
		}
	</script>
</body>
</html>
