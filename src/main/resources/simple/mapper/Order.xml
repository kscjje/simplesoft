<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.simplesoft.mapper.order.OrderMapper">
	<select id="selectOrderCheck" parameterType="com.simplesoft.order.service.RefundVO" resultType="com.simplesoft.order.service.RefundVO">
		/* OrderMapper.selectOrderCheck */
		SELECT
			 USER_NAME
			 , HINT1
			 , HINT2
			 , HINT3
			 , HINT4
			 , HINT5
			 , HINT6
			 , DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT
			 , DATE_FORMAT(HINT1_DATE, '%Y-%m-%d %H:%i:%s') AS HINT1_DATE
			 , DATE_FORMAT(HINT2_DATE, '%Y-%m-%d %H:%i:%s') AS HINT2_DATE
			 , DATE_FORMAT(HINT3_DATE, '%Y-%m-%d %H:%i:%s') AS HINT3_DATE
			 , DATE_FORMAT(HINT4_DATE, '%Y-%m-%d %H:%i:%s') AS HINT4_DATE
			 , DATE_FORMAT(HINT5_DATE, '%Y-%m-%d %H:%i:%s') AS HINT5_DATE
			 , DATE_FORMAT(HINT6_DATE, '%Y-%m-%d %H:%i:%s') AS HINT6_DATE
			 , DATE_FORMAT(SUC_DT, '%Y-%m-%d %H:%i:%s') AS SUC_DT
			 ,DATE_FORMAT(
				SEC_TO_TIME(
					GREATEST(
						TIME_TO_SEC(TIMEDIFF(DATE_ADD(REG_DT, INTERVAL 20 MINUTE), SUC_DT)),0
					)
				),'%i:%s'
			) AS TIME_TO_SUCCESS
		FROM room
		WHERE USER_NAME = #{userName}
	</select>
	
	<insert id="insertUser" parameterType="com.simplesoft.order.service.RefundVO">
		/* OrderMapper.insertUser */
		INSERT INTO room
			(
					USER_NAME
			)
		VALUES(
					#{userName}
		)
	</insert>
	<update id="updateTime" parameterType="com.simplesoft.order.service.RefundVO">
		/* OrderMapper.updateTime */
		UPDATE room SET REG_DT = SYSDATE() WHERE USER_NAME = #{userName} AND REG_DT IS NULL
	</update>
	<update id="success" parameterType="com.simplesoft.order.service.RefundVO">
		/* OrderMapper.updateSucTime */
		UPDATE room SET SUC_DT = SYSDATE() WHERE USER_NAME = #{userName} AND SUC_DT IS NULL
	</update>
	<update id="updateHint" parameterType="com.simplesoft.order.service.RefundVO">
		/* OrderMapper.updateHint */
		UPDATE room SET 
			UPD_DATE = SYSDATE()
			<choose>
				<when test="hint1 eq 1">
					, HINT1 = 'Y'
					, HINT1_DATE = SYSDATE()
				</when> 
				<when test="hint2 eq 1">
					, HINT2 = 'Y'
					, HINT2_DATE = SYSDATE()
				</when> 
				<when test="hint3 eq 1">
					, HINT3 = 'Y'
					, HINT3_DATE = SYSDATE()
				</when> 
				<when test="hint4 eq 1">
					, HINT4 = 'Y'
					, HINT4_DATE = SYSDATE()
				</when> 
				<when test="hint5 eq 1">
					, HINT5 = 'Y'
					, HINT5_DATE = SYSDATE()
				</when> 
				<when test="hint6 eq 1">
					, HINT6 = 'Y'
					, HINT6_DATE = SYSDATE()
				</when>
			</choose>
		WHERE USER_NAME = #{userName}
		<choose>
			<when test="hint1 eq 1">
				AND HINT1_DATE IS NULL
			</when> 
			<when test="hint2 eq 1">
				AND HINT2_DATE IS NULL
			</when> 
			<when test="hint3 eq 1">
				AND HINT3_DATE IS NULL
			</when> 
			<when test="hint4 eq 1">
				AND HINT4_DATE IS NULL
			</when> 
			<when test="hint5 eq 1">
				AND HINT5_DATE IS NULL
			</when> 
			<when test="hint6 eq 1">
				AND HINT6_DATE IS NULL
			</when>
		</choose>
	</update>
	
	<select id="selectAll" parameterType="com.simplesoft.order.service.RefundVO" resultType="CamelHashMap">
		/* OrderMapper.selectAll */
		SELECT
	       USER_NAME
	     , HINT1
	     , HINT2
	     , HINT3
	     , HINT4
	     , HINT5
	     , HINT6
	     , DATE_FORMAT(REG_DT, '%Y-%m-%d %H:%i:%s') AS REG_DT
	     , DATE_FORMAT(HINT1_DATE, '%Y-%m-%d %H:%i:%s') AS HINT1_DATE
	     , DATE_FORMAT(HINT2_DATE, '%Y-%m-%d %H:%i:%s') AS HINT2_DATE
	     , DATE_FORMAT(HINT3_DATE, '%Y-%m-%d %H:%i:%s') AS HINT3_DATE
	     , DATE_FORMAT(HINT4_DATE, '%Y-%m-%d %H:%i:%s') AS HINT4_DATE
	     , DATE_FORMAT(HINT5_DATE, '%Y-%m-%d %H:%i:%s') AS HINT5_DATE
	     , DATE_FORMAT(HINT6_DATE, '%Y-%m-%d %H:%i:%s') AS HINT6_DATE
	     , DATE_FORMAT(SUC_DT, '%Y-%m-%d %H:%i:%s') AS SUC_DT
	     , DATE_FORMAT(
	            SEC_TO_TIME(
	                GREATEST(
	                    TIME_TO_SEC(
	                        TIMEDIFF(
	                            DATE_ADD(REG_DT, INTERVAL 20 MINUTE), 
	                            SUC_DT
	                        )
	                    ),
	                    0
	                )
	            ),
	            '%i:%s'
	       ) AS TIME_TO_SUCCESS
		FROM room
		WHERE 1=1
		ORDER BY 
		    TIME_TO_SEC(
		        TIMEDIFF(
		            DATE_ADD(REG_DT, INTERVAL 20 MINUTE), 
		            SUC_DT
		        )
		    ) DESC
	</select>
	
	<update id="gameUpdate" parameterType="map">
		/* OrderMapper.gameUpdate */
		UPDATE game SET ON_OFF = #{onOff}, UPD_DATE = SYSDATE() WHERE SEQ = #{id}
	</update>
	
	<select id="selectAllGames" parameterType="com.simplesoft.order.service.RefundVO" resultType="CamelHashMap">
        SELECT 
        	  SEQ
        	, USER_NAME
        	, ON_OFF
        	, DATE_FORMAT(UPD_DATE, '%Y-%m-%d %H:%i:%s') AS UPD_DATE
        FROM game
        ORDER BY SEQ
    </select>
</mapper>