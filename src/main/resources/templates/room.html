<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8" />
	<title>ì´ê¹€ì²­ë…„ë¶€ ë°©íƒˆì¶œ</title>
	<link rel="stylesheet" href="/css/tailwind.min.css">
	<link rel="stylesheet" href="/css/all.min.css">
	<link rel="stylesheet" href="/css/room.css">
	<script src="/js/common/jquery-3.6.0.min.js"></script>
	<style>
		body{
			font-family: 'Nanum Gothic', sans-serif;
		}
		#result-modal .modal-content {
			padding : 45px 115px;
		}
	</style>
</head>
<body>
	<h1>ğŸ” Escape Room Timer</h1>

	<div class="timer" id="timer">20:00</div>
	
	<!--<img src="/qr" alt="QR Code"/>
	<img src="/qr2" alt="QR Code"/>
	<img src="/qr3" alt="QR Code"/>
	<img src="/qr4" alt="QR Code"/>
	<img src="/qr5" alt="QR Code"/>
	<img src="/qr6" alt="QR Code"/>-->
	<!-- íŒíŠ¸ ì½”ë“œ ì…ë ¥ -->
	<div class="hint-inputs" aria-label="íŒíŠ¸ ì½”ë“œ ì…ë ¥">
		<input type="text" maxlength="1" class="hint-input" id="code1" autocomplete="off" onkeydown="enterKey()"/>
		<input type="text" maxlength="1" class="hint-input" id="code2" autocomplete="off" onkeydown="enterKey()"/>
		<input type="text" maxlength="1" class="hint-input" id="code3" autocomplete="off" onkeydown="enterKey()"/>
		<input type="text" maxlength="1" class="hint-input" id="code4" autocomplete="off" onkeydown="enterKey()"/>
	</div>
	<div class="mt-5">íŒíŠ¸ ì‚¬ìš© : <span id="hindCnt">0</span> / 4</div>
	<div class="flex items-center space-x-2 mt-5">
		<button type="button" class="btn" onclick="resultBtn()">ìµœì¢… ì •ë‹µ ì…ë ¥</button>
		<button type="button" class="btn" id="check-hint-btn">íŒíŠ¸ í™•ì¸</button>
		<button type="button" id="clear-inputs-btn" style="width:3.5rem;height: 3.3rem" class="btn flex items-center justify-center text-gray-600 hover:text-red-500">
			<i class="fas fa-eraser"></i>
		</button>
	</div>
	<div class="hint-box" id="hint-box">íŒíŠ¸ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  'íŒíŠ¸ í™•ì¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
	<div id="result-modal" style="display:none;">
		<div class="modal-content relative p-8 rounded-xl bg-black border-2 border-cyan-400 shadow-xl text-center">
		<button type="button" id="close-modal2" class="absolute top-4 right-4 text-pink-400 font-bold hover:text-white transition duration-200" style="padding: 5px 10px;">Ã—</button>
			<input type="text" id="result" class="w-full px-4 py-3 mb-6 border border-gray-300 rounded-md text-black text-lg focus:outline-none focus:ring-2 focus:ring-cyan-400" onkeydown="enterKey()">
			<button type="button" id="result-yes" class="px-6 py-2 bg-black border-2 border-pink-500 text-pink-400 font-bold rounded-lg hover:bg-pink-500 hover:text-white transition duration-200">
			í™•ì¸
		</button>
		</div>
	</div>
	<!-- ì‹œì‘ ëª¨ë‹¬ -->
	<div id="start-modal">
		<div class="modal-content">
			<h2>ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h2>
			<button type="button" id="start-yes">ë„¤, ì‹œì‘í•©ë‹ˆë‹¤</button>
		</div>
	</div>
	
	<!-- íŒíŠ¸ ëª¨ë‹¬ -->
	<!--<div id="hint1-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="ì‹ë‹¨í‘œ" class="mb-5">
			<button type="button" id="hint1-yes">í™•ì¸</button>
		</div>
	</div>
	
	<div id="hint2-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="ì‹ë‹¨í‘œ" class="mb-5">
			<button type="button" id="hint2-yes">í™•ì¸</button>
		</div>
	</div>
	
	<div id="hint3-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="ì‹ë‹¨í‘œ" class="mb-5">
			<button type="button" id="hint3-yes">í™•ì¸</button>
		</div>
	</div>
	
	<div id="hint4-modal" class="hint-modal"style="display:none;">
		<div class="modal-content">
			<img src="image/foodtable.jpg" alt="ì‹ë‹¨í‘œ" class="mb-5">
			<button type="button" id="hint4-yes">í™•ì¸</button>
		</div>
	</div>-->
	
	<script>
		const TIMER_DURATION = 1200; // 20ë¶„
		let seconds = TIMER_DURATION;
		let interval;

		// íŒíŠ¸ ì½”ë“œ ì‚¬ì „
		const HINT_CODES = {
			'1111': `ì²« ë²ˆì§¸ íŒíŠ¸: ì…€ë¡œíŒì§€ë¥¼ ì˜ì–´ í‘œì— ëŒ€ì…í•˜ì—¬ ì˜¬ë°”ë¥¸ ë‹¨ì–´ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.`,
			'2222': `ë‘ ë²ˆì§¸ íŒíŠ¸: ê²Œì‹œíŒê³¼ ë§ì”€ ì¹´ë“œë¥¼ ëŒ€ì¡°í•´ ë³´ì„¸ìš”.`,
			'3333': `ì„¸ ë²ˆì§¸ íŒíŠ¸: ã„± = 1, ã„´ = 2ë¡œ ë‹µì„ ì°¾ì€ í›„ ë°©í–¥í‚¤ ìƒìë¥¼ í™•ì¸í•˜ì„¸ìš”.`,
			'4444': `ë„¤ ë²ˆì§¸ íŒíŠ¸: ì´ë²ˆ ìˆ˜ë ¨íšŒ ë³¸ë¬¸ ë§ì”€ ê¸€ìì— ëŒ€í•œ ì¢Œí‘œê°’ì…ë‹ˆë‹¤.`,
		};

		// íƒ€ì´ë¨¸ í‘œì‹œ
		function startTimer() {
			if (interval) return;

			interval = setInterval(() => {
				if (seconds <= 0) {
					clearInterval(interval);
					document.getElementById('timer').innerText = '00:00';
					return;
				}
				const min = String(Math.floor(seconds / 60)).padStart(2, '0');
				const sec = String(seconds % 60).padStart(2, '0');
				document.getElementById('timer').innerText = `${min}:${sec}`;
				seconds--;
			}, 1000);
		}
		
		function stopTimer(){
			clearInterval(interval);
		}
		const modal = document.getElementById('start-modal');
		const btnYes = document.getElementById('start-yes');
		
		const hint1Modal = document.getElementById('hint1-modal');
		const hint2Modal = document.getElementById('hint2-modal');
		const hint3Modal = document.getElementById('hint3-modal');
		const hint4Modal = document.getElementById('hint4-modal');
		
		btnYes.addEventListener('click', () => {
			saveStartTimeToServer();
		});
		/*hint1Modal.addEventListener('click', () => {
			$('#hint1-modal').hide();
		});
		hint2Modal.addEventListener('click', () => {
			$('#hint2-modal').hide();
		});
		hint3Modal.addEventListener('click', () => {
			$('#hint3-modal').hide();
		});
		hint4Modal.addEventListener('click', () => {
			$('#hint4-modal').hide();
		});
			*/
		// ì‹œì‘ ì‹œê°„ ì„œë²„ ì €ì¥ (POST)
		function saveStartTimeToServer() {
			$.ajax({
				url: '/start',
				type: 'POST',
				dataType: 'json',
				success: function (res) {
					if(res.data.RET_CODE == "FAIL"){
						alert("ì‚¬ìš©ìë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.");
						return;
					}
					startTimer();
					modal.style.display = 'none';
				},
				error: function () {
					console.error('ì‹œì‘ ì‹œê°„ ì €ì¥ ì‹¤íŒ¨');
				}
			});
		}

		// ì‹œì‘ ì‹œê°„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (GET)
		function loadStartTimeFromServer(callback) {
			$.ajax({
				url: '/load',
				type: 'GET',
				dataType: 'json',
				success: function (res) {
					if (res && res.data) {
						callback(res.data);
					} else {
						callback(null);
					}
				},
				error: function () {
					callback(null);
				}
			});
		}

		// íŒíŠ¸ ì‚¬ìš©
		function useHint(index) {
			$.ajax({
				url: '/useHint',
				type: 'GET',
				dataType: 'json',
				data : {
					index : index
				},
				success: function (res) {
					let data = res.data;
					let hintCount = 0;
					let hint1 = data.hint1 == "Y" ? 1 : 0;
					let hint2 = data.hint2 == "Y" ? 1 : 0;
					let hint3 = data.hint3 == "Y" ? 1 : 0;
					let hint4 = data.hint4 == "Y" ? 1 : 0;
					let hint5 = data.hint5 == "Y" ? 1 : 0;
					hintCount = hint1 + hint2 + hint3 + hint4 + hint5;
					const hindCnt = document.getElementById('hindCnt'); 
					hindCnt.textContent = hintCount
				},
				error: function () {
				}
			});
		}
		// ì…ë ¥ì°½ ìë™ í¬ì»¤ì‹± ë° ìœ íš¨ì„±
		const hintInputs = [
			document.getElementById('code1'),
			document.getElementById('code2'),
			document.getElementById('code3'),
			document.getElementById('code4')
		];

		function clearInputs() {
			hintInputs.forEach(input => input.value = '');
			hintInputs[0].focus();
		}

		document.getElementById('clear-inputs-btn').addEventListener('click', () => {
			$(".hint-input").val("");
		});
		document.getElementById('check-hint-btn').addEventListener('click', () => {
			const code = hintInputs.map(i => i.value.trim()).join('');
			const hintBox = document.getElementById('hint-box');
			const hindCnt = document.getElementById('hindCnt');

			if (code.length !== 4) {
				hintBox.textContent = '4ìë¦¬ íŒíŠ¸ ì½”ë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
				hintBox.style.color = '#ff00ff';
				return;
			}

			if (HINT_CODES[code]) {
				const keys = Object.keys(HINT_CODES); // ['1234', '5678', '9012', '3456']
				const index = keys.indexOf(code);     // codeê°€ '5678'ì´ë©´ indexëŠ” 1
				
				const timerText = document.getElementById('timer').innerText;
				const [min, sec] = timerText.split(':').map(Number);
				const totalSeconds = min * 60 + sec;
				const timeLimit = [15,10,5,5];
				
				if (totalSeconds >= timeLimit[index]*60) { // 15ë¶„ ì´ìƒ
					hintBox.textContent = `ì´ íŒíŠ¸ëŠ” ${timeLimit[index]}ë¶„ ì´í•˜ì¼ ë•Œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
					hintBox.style.color = '#ff0044';
					clearInputs();
					return; // í•¨ìˆ˜ íƒˆì¶œí•˜ì—¬ ë” ì´ìƒ ì§„í–‰ ì•ˆ í•¨
				}
				
				hintBox.innerHTML = HINT_CODES[code];
				hintBox.style.color = '#00ffff';
				clearInputs();
				
				
				useHint(index);
			} else {
				hintBox.textContent = 'ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒíŠ¸ ì½”ë“œì…ë‹ˆë‹¤.';
				hintBox.style.color = '#ff0044';
			}
		});

		hintInputs.forEach((input, idx) => {
			input.addEventListener('input', e => {
				e.target.value = e.target.value.toUpperCase().slice(0, 1);
				if (e.target.value && idx < hintInputs.length - 1) {
					hintInputs[idx + 1].focus();
				}
			});
			input.addEventListener('keydown', e => {
				if (e.key === 'Backspace' && !e.target.value && idx > 0) {
					hintInputs[idx - 1].focus();
				}
			});
		});

		// í˜ì´ì§€ ë¡œë“œì‹œ ì„œë²„ì—ì„œ ì‹œì‘ì‹œê°„ ë¶ˆëŸ¬ì™€ì„œ íƒ€ì´ë¨¸ ê³„ì‚°
		window.addEventListener('DOMContentLoaded', () => {
			loadStartTimeFromServer(function (data) {
				if(data.sucDt){
					modal.style.display = 'none';
					// ì‹œ:ë¶„:ì´ˆ í˜•ì‹ì´ë¼ë©´ ë¶„ê³¼ ì´ˆë¥¼ ë¶„ë¦¬
					const timeStr = data.timeToSuccess; // "00:00:12" ê°™ì€ ë¬¸ìì—´
					const parts = timeStr.split(':'); // ["00", "00", "12"]
					
					// ë°°ì—´ ê¸¸ì´ ì²´í¬ í›„ ë¶„, ì´ˆ ê°€ì ¸ì˜¤ê¸°
					let minute = "00", second = "00";
					if(parts.length === 3) {
					  minute = parts[1];
					  second = parts[2];
					} else if(parts.length === 2) {
					  // ì‹œê°€ ì—†ìœ¼ë©´ ë¶„, ì´ˆë§Œ ìˆëŠ” ê²½ìš°
					  minute = parts[0];
					  second = parts[1];
					}
					
					// ì•ì— 0 ë¶™ì´ê¸° (ë§Œì•½ í•œ ìë¦¬ ìˆ«ìë©´)
					minute = minute.padStart(2, '0');
					second = second.padStart(2, '0');
					
					const formatted = `${minute}:${second}`;
					document.getElementById('timer').innerText = formatted;
				} else if (data.regDt) {
					modal.style.display = 'none';
					const now = new Date();
					const start = new Date(data.regDt);
					const elapsed = Math.floor((now - start) / 1000);
					seconds = Math.max(TIMER_DURATION - elapsed, 0);
					
					let hintCount = 0;
					let hint1 = data.hint1 == "Y" ? 1 : 0;
					let hint2 = data.hint2 == "Y" ? 1 : 0;
					let hint3 = data.hint3 == "Y" ? 1 : 0;
					let hint4 = data.hint4 == "Y" ? 1 : 0;
					let hint5 = data.hint5 == "Y" ? 1 : 0;
					hintCount = hint1 + hint2 + hint3 + hint4 + hint5;
					const hindCnt = document.getElementById('hindCnt'); 
					hindCnt.textContent = hintCount
					startTimer();
				}
			});
		});
		enterKey = function(type){
			if (window.event.keyCode == 13) {
				$('#check-hint-btn').trigger("click");
			}
		}
		function resultBtn() {
		    // ëª¨ë‹¬ ì—´ê¸°
		    document.getElementById('result').value = ''; // ì…ë ¥ê°’ ì´ˆê¸°í™”
		    $("#result-modal").show();
		    document.getElementById('result').focus(); // ì»¤ì„œ ìë™ í¬ì»¤ìŠ¤
		}
		// ëª¨ë‹¬ì—ì„œ "í™•ì¸" ë²„íŠ¼ í´ë¦­ ì‹œ
		document.getElementById('result-yes').addEventListener('click', () => {
		    let userInput = document.getElementById('result').value;
		    checkAnswer(userInput);
		});
		// ì—”í„°í‚¤ë¡œ ì œì¶œ ê°€ëŠ¥í•˜ê²Œ
		document.getElementById('result').addEventListener('keydown', e => {
		    if (e.key === 'Enter') {
		        let userInput = document.getElementById('result').value;
		        checkAnswer(userInput);
		    }
		});
		
		function checkAnswer(userInput) {
		    let answer = "ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ë¶ˆê½ƒì´ë‹ˆ ê·¸ê°€ ë‚˜ì˜ ì•ˆì—ì„œ ì‚¬ë¼ì§€ì§€ ì•„ë‹ˆí•˜ëŠ”ì§€ë¼";
		
		    // ê³µë°± ì œê±° í›„ ë¹„êµ
		    let userInputNoSpace = userInput.replace(/\s+/g, '');
		    let answerNoSpace = answer.replace(/\s+/g, '');
		    const hintBox = document.getElementById('hint-box');
		
		    if (userInputNoSpace === answerNoSpace) {
		        hintBox.textContent = `ì •ë‹µ ì…ë‹ˆë‹¤.`;
		        hintBox.style.color = '#00ffff';
		        stopTimer(); // ì •ë‹µ ë§ì¶”ë©´ íƒ€ì´ë¨¸ ë©ˆì¶¤
		        success();
		    } else {
		        hintBox.textContent = `ì˜¤ë‹µ : ${userInput}`;
		        hintBox.style.color = '#ff0044';
		    }
		
		    // ëª¨ë‹¬ ë‹«ê¸°
		    document.getElementById('result-modal').style.display = 'none';
		}
		// ëª¨ë‹¬ ë‹«ê¸°
		$('#close-modal2').on('click', function () {
			$('#result-modal').hide();
		});
		
		
		// ì •ë‹µ
		function success() {
			$.ajax({
				url: '/success',
				type: 'GET',
				dataType: 'json',
				success: function (res) {
				},
				error: function () {
				}
			});
		}
	</script>
</body>
</html>
